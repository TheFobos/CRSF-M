# Инструкция для принимающего узла (192.168.1.1)

## Что нужно запустить

На принимающем узле нужно запустить **ДВА процесса** в разных терминалах:

---

## Терминал 1: Основное приложение CRSF

```bash
cd /home/dmitriy/Загрузки/CRSF
sudo ./crsf_io_rpi
```

**Что делает:** Основное приложение, которое обрабатывает CRSF протокол, читает команды из `/tmp/crsf_command.txt` и отправляет их по CRSF.

**Важно:** Требует права sudo для доступа к GPIO/UART.

---

## Терминал 2: API интерпретатор

```bash
cd /path/to/CRSF
./crsf_api_interpreter [порт] [IP_API_сервера] [порт_API_сервера]
```

**Примеры:**
```bash
# Локальный режим (без телеметрии)
./crsf_api_interpreter 8082

# Удаленный режим (с телеметрией)
./crsf_api_interpreter 8082 192.168.1.50 8081
```

**Что делает:** 
- Слушает HTTP запросы на порту 8082 от API сервера
- Получает команды управления (setChannel, setChannels, setMode и т.д.)
- Записывает команды в файл `/tmp/crsf_command.txt`
- Основное приложение читает эти команды и обрабатывает их
- **Если указан адрес API сервера:** читает телеметрию из `/tmp/crsf_telemetry.dat` и отправляет на API сервер

**Параметры:**
- `порт` - порт для прослушивания (по умолчанию: 8082)
- `IP_API_сервера` - IP адрес управляющей машины с API сервером (опционально, для телеметрии)
- `порт_API_сервера` - порт API сервера (по умолчанию: 8081, опционально)

---

## Проверка работы

### 1. Проверить что процессы запущены:
```bash
ps aux | grep -E "(crsf_io_rpi|crsf_api_interpreter)" | grep -v grep
```

### 2. Проверить что интерпретатор слушает порт 8082:
```bash
ss -tlnp | grep 8082
```

### 3. Проверить что команды записываются в файл:
```bash
tail -f /tmp/crsf_command.txt
```

Когда придут команды от API сервера, вы увидите их в этом файле.

### 4. Проверить права на файл команд:
```bash
ls -l /tmp/crsf_command.txt
```

Если файл не существует или нет прав на запись, создайте его:
```bash
touch /tmp/crsf_command.txt
chmod 666 /tmp/crsf_command.txt
```

---

## Порядок запуска

1. **Сначала** запустите основное приложение (`crsf_io_rpi`)
2. **Затем** запустите API интерпретатор (`crsf_api_interpreter`)

---

## Остановка

### Остановить API интерпретатор:
Нажмите `Ctrl+C` в терминале или:
```bash
pkill -f crsf_api_interpreter
```

### Остановить основное приложение:
Нажмите `Ctrl+C` в терминале или:
```bash
sudo pkill -f crsf_io_rpi
```

---

## Устранение проблем

### Ошибка "порт 8082 занят":
```bash
# Найти процесс
ss -tlnp | grep 8082
# Остановить
pkill -f crsf_api_interpreter
```

### Ошибка "не удается записать в /tmp/crsf_command.txt":
```bash
sudo touch /tmp/crsf_command.txt
sudo chmod 666 /tmp/crsf_command.txt
```

### Основное приложение не запускается:
- Убедитесь что используете `sudo`
- Проверьте что порты GPIO/UART свободны
- Проверьте логи приложения

---

## Пример полного запуска

```bash
# Терминал 1
cd /path/to/CRSF
sudo ./crsf_io_rpi

# Терминал 2 (в другом окне)
cd /path/to/CRSF
# Для работы с телеметрией:
./crsf_api_interpreter 8082 192.168.1.50 8081
# Или без телеметрии:
./crsf_api_interpreter 8082
```

После этого принимающий узел готов принимать команды от API сервера!

