# Руководство по использованию API с телеметрией

## Архитектура

Система состоит из двух узлов:

1. **Управляющая машина (ведущий узел)**:
   - Запускает `crsf_api_server` (порт 8081)
   - Запускает GUI `crsf_realtime_interface.py --api`

2. **Управляемая машина (ведомый узел)**:
   - Запускает `crsf_io_rpi` (основное приложение)
   - Запускает `crsf_api_interpreter` (порт 8082)

## Запуск системы

### На управляемой машине (ведомый узел):

1. Запустите основное приложение:
```bash
./crsf_io_rpi
```

2. Запустите API интерпретатор:
```bash
./crsf_api_interpreter [порт] [адрес_API_сервера] [порт_API_сервера]
```

Пример:
```bash
./crsf_api_interpreter 8082 192.168.1.100 8081
```

Где:
- `8082` - порт интерпретатора (по умолчанию)
- `192.168.1.100` - IP адрес управляющей машины с API сервером
- `8081` - порт API сервера (по умолчанию)

**Важно:** Для работы телеметрии через API интерпретатор должен быть запущен с указанием адреса API сервера. Если запустить только с портом (`./crsf_api_interpreter 8082`), телеметрия не будет отправляться.

### На управляющей машине (ведущий узел):

1. Запустите API сервер:
```bash
./crsf_api_server [порт] [адрес_ведомого_узла] [порт_интерпретатора]
```

Пример:
```bash
./crsf_api_server 8081 192.168.1.200 8082
```

Где:
- `8081` - порт API сервера (по умолчанию)
- `192.168.1.200` - IP адрес управляемой машины с интерпретатором
- `8082` - порт интерпретатора (по умолчанию)

2. Запустите GUI интерфейс:
```bash
python3 crsf_realtime_interface.py --api --api-url http://localhost:8081
```

## Как это работает

1. **Команды управления**:
   - GUI отправляет команды на API сервер (POST `/api/command/...`)
   - API сервер пересылает команды на интерпретатор ведомого узла
   - Интерпретатор записывает команды в `/tmp/crsf_command.txt`
   - Основное приложение читает команды и выполняет их

2. **Телеметрия**:
   - Основное приложение записывает телеметрию в `/tmp/crsf_telemetry.dat` каждые 20мс
   - API интерпретатор читает телеметрию из файла каждые 20мс
   - API интерпретатор отправляет телеметрию на API сервер (POST `/api/telemetry`) при изменениях
   - API сервер хранит последнюю телеметрию в памяти
   - GUI получает телеметрию через GET `/api/telemetry`
   - Телеметрия обновляется в реальном времени (до 50 Гц)

## Проверка работы

### Проверка API сервера:
```bash
curl http://localhost:8081/
```

### Проверка получения телеметрии:
```bash
curl http://localhost:8081/api/telemetry
```

### Проверка отправки команды:
```bash
curl -X POST http://localhost:8081/api/command/setChannel \
  -H "Content-Type: application/json" \
  -d '{"channel":1,"value":1500}'
```

## Требования

- Python 3.6+
- requests (pip install requests)
- tkinter (обычно входит в Python, на Linux может потребоваться `python3-tk`)
- Собранные бинарники: `crsf_api_server`, `crsf_api_interpreter`, `crsf_io_rpi`

## Формат телеметрии

API возвращает телеметрию в JSON формате:

```json
{
  "linkUp": true,
  "lastReceive": 1234567890,
  "channels": [1500, 1500, 1000, 1500, ...],
  "gps": {
    "latitude": 55.7558,
    "longitude": 37.6173,
    "altitude": 100.0,
    "speed": 0.0
  },
  "battery": {
    "voltage": 12.6,
    "current": 0.0,
    "capacity": 5000.0,
    "remaining": 100
  },
  "attitude": {
    "roll": 0.0,
    "pitch": 0.0,
    "yaw": 0.0
  },
  "attitudeRaw": {
    "roll": 0,
    "pitch": 0,
    "yaw": 0
  },
  "timestamp": "12:34:56.789",
  "activePort": "UART Active"
}
```

## Установка зависимостей

```bash
pip install -r requirements.txt
```

На Linux для tkinter:
```bash
sudo apt-get install python3-tk
```
